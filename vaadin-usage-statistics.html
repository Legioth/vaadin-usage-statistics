<!--

This script gathers usage statistics from the application running in development mode.

Statistics gathering is automatically disabled and excluded from production builds.

For details and to opt-out, see https://github.com/vaadin/vaadin-usage-statistics.

-->
<link rel="import" href="../vaadin-development-mode-detector/vaadin-development-mode-detector.html">
<link rel="import" href="vaadin-usage-statistics-gatherer.html">
<link rel="import" href="vaadin-usage-statistics-storage.html">
<link rel="import" href="vaadin-usage-statistics-sender.html">

<script>
  class StatisticsLogger {
    constructor(id) {
      this.id = id;
    }

    _isDebug() {
      return localStorage.getItem("vaadin."+this.id+".debug");
    }

    debug(msg) {
      if (this._isDebug()) {
        console.info(this.id+": "+msg);
      }
    }
  }

  const usageStatisticsVersion = "0.0.1";
  class UsageStatistics {
    constructor() {
      this.now = new Date();
      this.timeNow = this.now.getTime();
      this.firstUseKey = "vaadin.statistics.firstuse";
      this.monthProcessedKey = "vaadin.statistics.monthProcessed"
      this.optOutKey = "vaadin.statistics.optout";
      this.gatherDelay = 10; // Delay between loading this file and gathering stats
      this.initialDelay = 24*60*60;

      this.logger = new StatisticsLogger("statistics");
      this.storage = new StatisticsStorage("vaadin.statistics.basket");
      this.gatherer = new StatisticsGatherer(this.logger);
      this.sender = new StatisticsSender("https://tools.vaadin.com/usage-stats/submit", this.logger);

    }
    maybeGatherAndSend() {
      if (localStorage.getItem(this.optOutKey)) {
        return;
      }
      this.gatherer.gather(this.storage);
      setTimeout(() => {
          this.maybeSend();
      }, this.gatherDelay*1000);
    }

    lottery() {
      return Math.random() <= 0.05;
    }

    maybeSend() {
      var firstUse = Number(localStorage.getItem(this.firstUseKey));
      const monthProcessed = Number(localStorage.getItem(this.monthProcessedKey));

      if (!firstUse) {
        // Use a grace period to avoid interfering with tests, incognito mode etc
        firstUse = this.timeNow;
        localStorage.setItem(this.firstUseKey, firstUse);
      }

      if (this.timeNow < (firstUse + this.initialDelay*1000)) {
        this.logger.debug("No statistics will be sent until the initial delay of " + this.initialDelay + "s has passed");
        return;
      }
      const thisMonth = this.now.getYear()*12+this.now.getMonth();
      if (thisMonth <= monthProcessed) {
        this.logger.debug("This month has already been processed");
        return;
      }
      localStorage.setItem(this.monthProcessedKey, thisMonth);
      // Use random sampling
      if (this.lottery()) {
        this.logger.debug("Congratulations, we have a winner!");
      } else {
        this.logger.debug("Sorry, no stats from you this time");
        return;
      }

      this.send();
    }

    send() {
      // Ensure we have the latest data
      this.gatherer.gather(this.storage);

      // Read, send and clean up
      var data = this.storage.read();
      data["firstUse"] = Number(localStorage.getItem(this.firstUseKey));
      data["usageStatisticsVersion"] = usageStatisticsVersion;
      const info = 'This request contains usage statistics gathered from the application running in development mode. \n\nStatistics gathering is automatically disabled and excluded from production builds.\n\nFor details and to opt-out, see https://github.com/vaadin/vaadin-usage-statistics.\n\n\n\n';
      this.sender.send(info+JSON.stringify(data), function() {
        // Revert the 'month processed' flag
        localStorage.setItem(this.monthProcessedKey, thisMonth-1);
      });
    }
  }

  window.Vaadin.developmentModeCallback = window.Vaadin.developmentModeCallback || {};
  window.Vaadin.developmentModeCallback["vaadin-usage-statistics"] = function() {
    new UsageStatistics().maybeGatherAndSend();
  };

</script>
