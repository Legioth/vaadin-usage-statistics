<!--

This script gathers usage statistics from the application running in development mode.

Statistics gathering is automatically disabled and excluded from production builds.

For details and to opt-out, see https://github.com/vaadin/vaadin-usage-statistics.

-->
<link rel="import" href="../vaadin-development-mode-detector/vaadin-development-mode-detector.html">
<link rel="import" href="vaadin-usage-statistics-gatherer.html">
<link rel="import" href="vaadin-usage-statistics-storage.html">
<link rel="import" href="vaadin-usage-statistics-sender.html">

<script>
{
  class StatisticsLogger {
    constructor(id) {
      this.id = id;
    }

    _isDebug() {
      return localStorage.getItem("vaadin."+this.id+".debug");
    }

    debug(msg) {
      if (this._isDebug()) {
        console.info(this.id+": "+msg);
      }
    }
  }

  const usageStatisticsVersion = "0.0.1";
  const now = new Date().getTime();
  const firstPingKey = "vaadin.statistics.firstping";
  const lastPingKey = "vaadin.statistics.lastping";
  const optOutKey = "vaadin.statistics.optout";
  const gatherDelay = 10000; // Delay between loading this file and gathering stats

  const initialDelay = 24*60*60;
  const reportingInterval = 60*60*24;

  const logger = new StatisticsLogger("statistics");
  const storage = new StatisticsStorage("vaadin.statistics.basket");
  const gatherer = new StatisticsGatherer(logger);
  const sender = new StatisticsSender("https://tools.vaadin.com/usage-stats/submit", logger);

  const triggerSending = function() {
    setTimeout(() => {
      const firstPing = Number(localStorage.getItem(firstPingKey));
      const lastPing = Number(localStorage.getItem(lastPingKey));

      if (!firstPing) {
        // Use a grace period to avoid interfering with tests, incognito mode etc
        localStorage.setItem(firstPingKey, now);
        localStorage.setItem(lastPingKey, now);
        logger.debug("No statistics will be sent until the initial delay of " + initialDelay + "s has passed");
        return;
      }

      if (now < (lastPing + reportingInterval) ) {
        logger.debug("Statistics will not be sent until " + (reportingInterval-(now-lastPing)/1000) + "s has passed");
        return;
      }

      gatherer.gather(storage);
      const hasStats = !storage.isEmpty();

      localStorage.setItem(lastPingKey, new Date().getTime());
      storage.clear();
      if (!hasStats) {
        logger.debug("No relevant products in use");
        return;
      }

      var data = storage.read();
      data["firstPing"] = firstPing;
      data["usageStatisticsVersion"] = usageStatisticsVersion;
      const info = 'This request contains usage statistics gathered from the application running in development mode. \n\nStatistics gathering is automatically disabled and excluded from production builds.\n\nFor details and to opt-out, see https://github.com/vaadin/vaadin-usage-statistics.\n\n\n\n';
      sender.send(info+JSON.stringify(data));
    }, gatherDelay);
  }

  window.Vaadin.developmentModeCallback = window.Vaadin.developmentModeCallback || {};
  window.Vaadin.developmentModeCallback["vaadin-usage-statistics"] = function() {
    if (localStorage.getItem(optOutKey)) {
      return;
    }
    gatherer.gather(storage);
    triggerSending();
  };
}
</script>
