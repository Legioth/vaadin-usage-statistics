<!--

This script gathers usage statistics from the application running in development mode.

Statistics gathering is automatically disabled and excluded from production builds.

For details and to opt-out, see https://github.com/vaadin/vaadin-usage-statistics.

-->
<link rel="import" href="../vaadin-development-mode-detector/vaadin-development-mode-detector.html">
<link rel="import" href="vaadin-usage-statistics-gatherer.html">
<link rel="import" href="vaadin-usage-statistics-storage.html">
<link rel="import" href="vaadin-usage-statistics-sender.html">

<script>
{
  class StatisticsLogger {
    constructor(id) {
      this.id = id;
    }

    _isDebug() {
      return localStorage.getItem("vaadin."+this.id+".debug");
    }

    debug(msg) {
      if (this._isDebug()) {
        console.info(this.id+": "+msg);
      }
    }
  }

  const usageStatisticsVersion = "0.0.1";
  class UsageStatistics {
    constructor() {
      this.now = new Date().getTime();
      this.firstUseKey = "vaadin.statistics.firstuse";
      this.lastPingKey = "vaadin.statistics.lastping";
      this.optOutKey = "vaadin.statistics.optout";
      this.gatherDelay = 10000; // Delay between loading this file and gathering stats

      this.initialDelay = 24*60*60;
      this.reportingInterval = 60*60*24;

      this.logger = new StatisticsLogger("statistics");
      this.storage = new StatisticsStorage("vaadin.statistics.basket");
      this.gatherer = new StatisticsGatherer(this.logger);
      this.sender = new StatisticsSender("https://tools.vaadin.com/usage-stats/submit", this.logger);

    }
    maybeGatherAndSend() {
      if (localStorage.getItem(this.optOutKey)) {
        return;
      }
      this.gatherer.gather(this.storage);
      setTimeout(() => {
          this.maybeSend();
      }, this.gatherDelay);
    }

    maybeSend() {
      var firstUse = Number(localStorage.getItem(this.firstUseKey));
      const lastPing = Number(localStorage.getItem(this.lastPingKey));

      if (!firstUse) {
        // Use a grace period to avoid interfering with tests, incognito mode etc
        firstUse = this.now;
        localStorage.setItem(this.firstUseKey, firstUse);
      }

      if (this.now < (firstUse + this.initialDelay)) {
        this.logger.debug("No statistics will be sent until the initial delay of " + this.initialDelay + "s has passed");
        return;
      }
      if (this.now < (lastPing + this.reportingInterval) ) {
        this.logger.debug("Statistics will not be sent until " + (this.reportingInterval-(this.now-lastPing)/1000) + "s has passed");
        return;
      }

      this.gatherer.gather(this.storage);
      const hasStats = !this.storage.isEmpty();

      localStorage.setItem(this.lastPingKey, new Date().getTime());
      this.storage.clear();
      if (!hasStats) {
        this.logger.debug("No relevant products in use");
        return;
      }

      var data = this.storage.read();
      data["firstUse"] = firstUse;
      data["usageStatisticsVersion"] = usageStatisticsVersion;
      const info = 'This request contains usage statistics gathered from the application running in development mode. \n\nStatistics gathering is automatically disabled and excluded from production builds.\n\nFor details and to opt-out, see https://github.com/vaadin/vaadin-usage-statistics.\n\n\n\n';
      this.sender.send(info+JSON.stringify(data));
    }
  }

  window.Vaadin.developmentModeCallback = window.Vaadin.developmentModeCallback || {};
  window.Vaadin.developmentModeCallback["vaadin-usage-statistics"] = function() {
    new UsageStatistics().maybeGatherAndSend();
  };
}
</script>
